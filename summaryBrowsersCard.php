<?php
    include_once('./inc/browsers.inc.php');
    include_once('./lib/parseUserAgentString.php'); // Parse User Agent https://www.toms-world.org/blog/parseuseragentstring/
?>

<?php
    $hookedBrowsersList = getHookedBrowsers();
    
    foreach ($hookedBrowsersList as $row) {                                            
        $parser = new parseUserAgentStringClass();
        $parser->includeAndroidName = true;
        $parser->includeWindowsName = true;
        $parser->includeMacOSName = true;
        $parser->parseUserAgentString($row['userAgent']);
        $browserName = "N/A";
        $osName = "N/A";
        $browserVersion = "N/A";
        $browserType = "N/A";
        $phpdate = date("d/m/Y H:i:s", strtotime($row['hookedDate']));

        if ($parser->knownbrowser) { 
            $browserName = $parser->browsername;
            $osName = $parser->osname;
            $browserVersion = $parser->browserversion;
            $browserType = $parser->type;
        }
?>
<tr>
    <?php
        // Process last activity as heartbeat
    
        if(isAlive($row['lastHeatbeat'])) {
            echo '<td class="text-center"><img src="./images/online_button.png" height="16" width="16"/></td>';
        }
        else {
            echo '<td class="text-center"><img src="./images/offline_button.png" height="16" width="16"/></td>';
        }            
        echo '<td><a href="browserDetails.php?browserId=' . htmlspecialchars($row['browserId']) . '" class="clientID">' . htmlspecialchars($row['browserId']) . '</a></td>';
        echo '<td>' . htmlspecialchars($osName) . '</td>';
        echo '<td>' . htmlspecialchars($browserName) . '</td>';
        echo '<td>' . htmlspecialchars($browserVersion) . '</td>';
        echo '<td>' . htmlspecialchars($browserType) . '</td>';
        echo '<td>' . htmlspecialchars($row['publicIP']) . '</td>';
        echo '<td>' . htmlspecialchars($row['hostname']) . '</td>';
        echo '<td>' . htmlspecialchars($phpdate) . '</td>';
        echo '<td>
            <a class="btn btn-light shadow-none ui-action-icons-details p-1" href="browserDetails.php?browserId=' . htmlspecialchars($row['browserId']) . '" role="button"><i class="bi bi-search"></i></a>
            <a class="btn btn-danger shadow-none ui-action-icons-delete p-1" href="index.php?delete=' . htmlspecialchars($row['browserId']) . '" role="button"><i class="bi bi-trash"></i></a>
        </td>';
    ?>
</tr>
<?php
    }
?>